<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TESTCASES • RAG</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* same styles as before (kept for brevity) */
    :root{
      --black:#000000;
      --accent:#86BC25;
      --white:#ffffff;
      --panel: rgba(134,188,37,0.03);
      --muted: rgba(255,255,255,0.50);
      --muted-2: rgba(255,255,255,0.3);
      --radius:14px;
      --fw-sans: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      --easing: cubic-bezier(.2,.9,.2,1);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:var(--fw-sans);background:var(--black);color:var(--white);-webkit-font-smoothing:antialiased;line-height:1.4}
    a { color: var(--accent); text-decoration: none; }

    .app{max-width:1200px;margin:28px auto;padding:20px}
    .navbar{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:12px;margin-bottom:12px;border:2px solid rgba(255,255,255,0.95);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00))}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),rgba(134,188,37,0.92));display:flex;align-items:center;justify-content:center;font-weight:800;font-size:18px;color:var(--black)}
    header{display:flex;align-items:center;gap:18px;margin-bottom:12px}
    h1{font-size:20px;margin:0}
    .subtitle{color:var(--muted);font-size:13px}
    .layout{display:grid;grid-template-columns:360px 1fr;gap:18px}
    .panel{background:linear-gradient(180deg,var(--panel),transparent);border-radius:var(--radius);padding:18px;border:2px solid rgba(255,255,255,0.95);backdrop-filter: blur(6px)}
    .muted{color:var(--muted);font-size:13px}
    .dropzone{border:2px dashed rgba(255,255,255,0.12);padding:16px;border-radius:12px;display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center;min-height:120px;transition:box-shadow .18s var(--easing),transform .18s var(--easing)}
    .file-btn{background:var(--accent);color:var(--black);border:none;padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer}
    .actions{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .btn{background:transparent;border:2px solid rgba(255,255,255,0.95);color:var(--white);padding:10px;border-radius:12px;cursor:pointer;font-weight:700}
    .btn.warn{border-color:rgba(255,0,0,0.9);color:#ffbdbd}
    .search-bar{display:flex;gap:10px;align-items:center}
    .input{flex:1;background:transparent;border:2px solid rgba(255,255,255,0.9);padding:12px 14px;border-radius:12px;color:var(--white);outline:none;font-weight:600}
    .search-btn{background:var(--accent);color:var(--black);border:none;padding:12px 18px;border-radius:12px;cursor:pointer;font-weight:800}
    .search-meta{margin-top:12px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .result-pill{background:transparent;padding:8px 12px;border-radius:999px;border:2px solid rgba(255,255,255,0.95);font-weight:800;color:var(--accent);font-size:13px}
    .controls{display:flex;gap:8px;align-items:center}
    .select{appearance:none;border-radius:10px;padding:8px 36px 8px 12px;border:2px solid rgba(255,255,255,0.9);background:var(--white);color:var(--black);font-weight:700}
    .results{margin-top:18px;display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:18px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border-radius:12px;padding:16px;border:2px solid rgba(255,255,255,0.95);display:flex;flex-direction:column;gap:10px;transition:transform .16s var(--easing),box-shadow .16s var(--easing)}
    .card:hover{transform:translateY(-6px)}
    .meta{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
    .id-pill{background:var(--accent);color:var(--black);padding:8px 10px;border-radius:10px;font-weight:900;word-break:break-all}
    .match-pill{background:transparent;color:var(--white);font-weight:900;border:2px solid rgba(255,255,255,0.95);padding:6px 10px;border-radius:8px}
    .card h3{margin:0;font-size:16px}
    .card p{margin:0;color:var(--muted-2);font-size:13px}
    .keywords{display:flex;gap:8px;flex-wrap:wrap}
    .kw{padding:6px 10px;border-radius:999px;border:2px solid rgba(255,255,255,0.9);font-weight:700;font-size:12px;color:var(--muted)}
    .footer-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    .btn-sm{padding:8px 12px;border-radius:10px;font-weight:800;border:none;cursor:pointer}
    .btn-sm.edit{background:transparent;border:2px solid rgba(255,255,255,0.9);color:var(--white)}
    .btn-sm.primary{background:var(--accent);color:var(--black);border:2px solid var(--accent)}
    .summary { font-size:13px; color:var(--muted-2); margin-top:6px; max-height:84px; overflow:hidden; }
    .match-bar { height:8px; border-radius:999px; background:rgba(255,255,255,0.06); overflow:hidden; margin-top:8px; }
    .match-fill { height:100%; background:linear-gradient(90deg,var(--accent), #b9e66f); width:0%; transition:width .4s ease; }
    @media (max-width:880px){ .layout{grid-template-columns:1fr} .results{grid-template-columns:1fr} }
    .focus-ring:focus{outline:4px solid rgba(134,188,37,0.12);outline-offset:3px}
  </style>
</head>
<body>
  <div class="app" id="app-root">
    <div id="navbar" class="navbar" style="display:none">
      <div style="display:flex;align-items:center;gap:12px"><div class="logo">TC</div><div><div style="font-weight:800">TESTCASES — RAG</div><div class="subtitle" style="font-size:12px">All Test Cases</div></div></div>
      <div style="margin-left:auto;display:flex;gap:8px"><button id="nav-back" class="btn focus-ring">← Back</button><button id="nav-delete" class="btn warn focus-ring">Delete All</button></div>
    </div>

    <div id="main-view">
      <header>
        <div class="logo">MB.</div>
        <div>
          <h1>TESTCASES RAG</h1>
          <div class="subtitle">Upload · Search · Edit · Export </div>
        </div>
      </header>

      <main class="layout">
        <aside class="panel" aria-labelledby="upload-heading">
          <h2 id="upload-heading">Upload Cases</h2>
          <div class="dropzone" id="dropzone" tabindex="0" aria-label="Drop test case files here">
            <div class="muted">Drag & drop CSV / XLSX here or</div>
            <div style="display:flex;gap:10px;align-items:center">
              <label class="file-btn focus-ring" for="file-input">Choose file</label>
              <button id="process-btn" class="btn focus-ring">Process</button>
            </div>
            <div class="muted" id="drop-hint">Supported: .csv, .xlsx · Max: 10MB</div>
            <input id="file-input" class="file-input" type="file" accept=".csv,.xlsx,.xls" />
          </div>

          <div class="actions">
            <button id="show-all" class="btn focus-ring">Show All Test Cases</button>
            <button id="delete-all" class="btn warn focus-ring">Delete All Test Cases</button>
            <div id="upload-status" class="small muted" aria-live="polite"></div>
          </div>

          <hr style="margin:16px 0;border:none;border-top:1px solid rgba(255,255,255,0.08)" />
          <div>
            <h2 style="font-size:13px;margin-bottom:8px;color:var(--accent)">Quick Actions</h2>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button id="export-json" class="btn focus-ring">Export JSON</button>
              <button id="clear-cache" class="btn focus-ring">Clear Local Cache</button>
            </div>
          </div>
        </aside>

        <section>
          <div class="panel" aria-labelledby="search-heading">
            <h2 id="search-heading">Find Test Cases</h2>
            <form id="search-form" class="search-bar" role="search">
              <input id="q" class="input focus-ring" placeholder="Search e.g. 'invalid login + timeout'" aria-label="Search test cases" />
              <button type="submit" class="search-btn focus-ring">Search</button>
            </form>

            <div id="search-meta" class="search-meta" aria-live="polite">
              <div class="result-pill" id="result-count">No search yet</div>

              <div class="controls" role="region" aria-label="Sort and filter controls">
                <select id="sort" class="select focus-ring" aria-label="Sort results">
                  <option value="relevance">Relevance</option>
                  <option value="recent">Most Recent</option>
                  <option value="id">Test Case ID</option>
                </select>
                <button id="sort-dir" class="btn focus-ring" title="Toggle sort direction">↕</button>
                <button id="clear-filters" class="btn focus-ring" title="Clear filters">Clear</button>
              </div>
            </div>

            <div id="results" class="results" aria-live="polite"></div>
            <div id="no-results" class="small muted" style="display:none;margin-top:12px">No results — try changing keywords or upload cases.</div>
          </div>
        </section>
      </main>
    </div>

    <div id="all-view" style="display:none">
      <div class="all-page" style="max-width:1200px;margin:0 auto;">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 style="margin:0;color:var(--white)">All Test Cases</h2>
          <div style="display:flex;gap:8px">
            <button id="all-delete" class="btn warn focus-ring">Delete All</button>
            <button id="all-export" class="btn focus-ring">Export JSON</button>
          </div>
        </div>
        <div id="all-results" class="results" aria-live="polite"></div>
      </div>
    </div>

    <div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.95);z-index:40;opacity:0;pointer-events:none;transition:opacity .18s ease;">
      <div class="modal-panel" role="document" style="width:720px;background:var(--black);border-radius:16px;padding:22px;border:2px solid var(--accent);box-shadow:0 0 40px rgba(134,188,37,0.2);transform:translateY(8px);transition:transform .18s ease;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <strong style="color:var(--accent)">Edit Test Case</strong>
          <button id="modal-close" class="btn focus-ring">Close</button>
        </div>
        <form id="edit-form" style="display:flex;flex-direction:column;gap:10px">
          <input id="edit-id" type="hidden" />
          <label class="small">Feature</label>
          <input id="edit-feature" class="input focus-ring" />
          <label class="small">Description</label>
          <textarea id="edit-desc" class="input focus-ring" rows="4"></textarea>
          <label class="small">Pre-requisites</label>
          <input id="edit-prereq" class="input focus-ring" />
          <label class="small">Steps (combined)</label>
          <textarea id="edit-steps" class="input focus-ring" rows="6"></textarea>

          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:6px">
            <button type="button" id="cancel-edit" class="btn focus-ring">Cancel</button>
            <button type="submit" class="btn-sm primary focus-ring">Save</button>
          </div>
          <div id="edit-status" class="small muted" aria-live="polite"></div>
        </form>
      </div>
    </div>
  </div>

  <script>
/* App JS - updated to display summary and call delete endpoint */
const fileInput = document.getElementById('file-input');
const dropzone = document.getElementById('dropzone');
const processBtn = document.getElementById('process-btn');
const uploadStatus = document.getElementById('upload-status');
const showAllBtn = document.getElementById('show-all');
const deleteAllBtn = document.getElementById('delete-all');
const resultsEl = document.getElementById('results');
const noResultsEl = document.getElementById('no-results');
const qInput = document.getElementById('q');
const searchForm = document.getElementById('search-form');
const modal = document.getElementById('modal');
const modalClose = document.getElementById('modal-close');
const editForm = document.getElementById('edit-form');
const resultCount = document.getElementById('result-count');
const sortEl = document.getElementById('sort');
const sortDirBtn = document.getElementById('sort-dir');
const clearFiltersBtn = document.getElementById('clear-filters');

const navbar = document.getElementById('navbar');
const navBack = document.getElementById('nav-back');
const navDelete = document.getElementById('nav-delete');

const allView = document.getElementById('all-view');
const allResults = document.getElementById('all-results');
const allDelete = document.getElementById('all-delete');
const allExport = document.getElementById('all-export');

let lastFiles = null;
let lastView = null;
let sortDir = 'desc';
let _prevActiveElement = null;

// drag & drop
;['dragenter','dragover'].forEach(evt=>dropzone.addEventListener(evt,(e)=>{e.preventDefault();dropzone.classList.add('dragover')}))
;['dragleave','drop'].forEach(evt=>dropzone.addEventListener(evt,(e)=>{e.preventDefault();dropzone.classList.remove('dragover')}))
dropzone.addEventListener('drop',(e)=>{const f=e.dataTransfer.files[0]; if(f){fileInput.files=e.dataTransfer.files; lastFiles=e.dataTransfer.files; setUploadHint(f.name)}})
dropzone.addEventListener('keydown',(e)=>{if(e.key==='Enter' || e.key===' ') fileInput.click()})

fileInput.addEventListener('change',(e)=>{lastFiles=fileInput.files; if(lastFiles?.length) setUploadHint(lastFiles[0].name)})
function setUploadHint(name){uploadStatus.textContent='Selected: '+name}

processBtn.addEventListener('click', async ()=>{
  if(!lastFiles?.length){uploadStatus.textContent='Please choose a file first.';return}
  const fd=new FormData(); fd.append('file', lastFiles[0]); uploadStatus.textContent='Uploading…';
  try{const res=await fetch('/api/upload',{method:'POST',body:fd}); const data=await res.json(); if(!res.ok) throw new Error(data.detail||res.statusText); uploadStatus.textContent=data.message||'Uploaded'; navigateTo('all'); }catch(err){uploadStatus.textContent='Upload failed: '+err.message}
})

// SEARCH
searchForm.addEventListener('submit', async (e)=>{ e.preventDefault(); const q=qInput.value.trim(); if(!q) return; lastView='search'; resultsEl.innerHTML=''; noResultsEl.style.display='none'; resultCount.textContent='Searching…'; try{const res=await fetch('/api/search',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query:q})}); const data=await res.json(); if(!res.ok) throw new Error(data.detail||res.statusText); renderResults(data.results||[], true); }catch(err){resultCount.textContent='Search failed: '+err.message} })

// SHOW ALL navigates to "all page"
showAllBtn.addEventListener('click', ()=> navigateTo('all'));
function navigateTo(page){
  if(page === 'all'){
    history.pushState({page:'all'}, '', '/all');
    document.getElementById('main-view').style.display = 'none';
    navbar.style.display = 'flex';
    allView.style.display = 'block';
    navDelete.onclick = () => deleteAllConfirmed();
    fetchAllTests();
  } else {
    history.pushState({page:'search'}, '', '/');
    document.getElementById('main-view').style.display = 'block';
    navbar.style.display = 'none';
    allView.style.display = 'none';
  }
}
navBack?.addEventListener('click', ()=> { history.pushState({page:'search'}, '', '/'); navigateTo('search');});
window.addEventListener('popstate', (e)=>{ if(e.state && e.state.page === 'all') navigateTo('all'); else navigateTo('search');});

// fetch & render all tests
async function fetchAllTests(){
  allResults.innerHTML = '<div style="color:var(--muted)">Loading all test cases…</div>';
  try{
    const res = await fetch('/api/get-all');
    const data = await res.json();
    if(!res.ok) throw new Error(data.detail||res.statusText);
    const formatted = (data.test_cases || []).map(tc => ({
      id: tc.id || tc['Test Case ID'],
      feature: tc['Feature'],
      description: tc['Test Case Description'],
      prerequisites: tc['Pre-requisites'],
      steps: tc['Steps'],
      summary: tc.TestCaseSummary || tc.TestCaseSummary || '',
      keywords: tc.TestCaseKeywords || [],
    }));
    renderResults(formatted, false, allResults);
  }catch(err){
    allResults.innerHTML = `<div style="color:var(--muted)">Failed to load: ${err.message}</div>`;
  }
}

// delete handlers
deleteAllBtn.addEventListener('click', ()=> deleteAllConfirmed());
allDelete.addEventListener('click', ()=> deleteAllConfirmed());
navDelete && navDelete.addEventListener('click', ()=> deleteAllConfirmed());

async function deleteAllConfirmed(){
  if(!confirm('Are you sure you want to delete ALL test cases? This is irreversible.')) return;
  try{
    const res = await fetch('/api/delete-all?confirm=true', { method: 'POST' });
    const data = await res.json();
    if(!res.ok) throw new Error(data.detail||res.statusText);
    alert(data.message || 'Deleted');
    if(document.getElementById('main-view').style.display !== 'none') { resultsEl.innerHTML=''; resultCount.textContent='0 results'; }
    if(allView.style.display !== 'none') { allResults.innerHTML=''; }
  }catch(err){
    alert('Deletion failed: '+err.message);
  }
}

// render results (targetContainer optional - default to resultsEl)
function renderResults(items, isSearch=false, targetContainer = resultsEl){
  targetContainer.innerHTML = '';
  if(!items || items.length === 0){
    if(targetContainer === resultsEl) { noResultsEl.style.display='block'; resultCount.textContent='0 results'; }
    else targetContainer.innerHTML = '<div style="color:var(--muted)">No test cases found.</div>';
    return;
  }
  if(targetContainer === resultsEl) { noResultsEl.style.display='none'; resultCount.textContent = items.length + ' result' + (items.length>1?'s':''); }

  const sortBy = sortEl?.value || 'relevance';
  items = sortClientSide(items, sortBy, sortDir);

  items.forEach(it=>{
    const id = it.id || it['id'] || it['Test Case ID'] || Math.random().toString(36).slice(2,8);
    const feature = it.feature || it['Feature'] || '—';
    const desc = it.description || it['Test Case Description'] || it.summary || '';
    const summary = it.summary || '';
    const keywords = it.keywords || it.TestCaseKeywords || [];
    const score = isSearch && (it.probability || it.score) ? Math.round(it.probability || it.score) : null;

    const card = document.createElement('article');
    card.className = 'card';
    card.tabIndex = 0;

    const metaHTML = `
      <div class="meta">
        <div style="display:flex;gap:12px;align-items:flex-start">
          <div>
            <div class="id-pill">${escapeHtml(String(id))}</div>
            <div style="font-size:13px;color:var(--muted);margin-top:6px">${escapeHtml(feature)}</div>
          </div>
        </div>
        <div style="min-width:110px;text-align:right">
          ${score !== null ? `<div class="match-pill">${score}% MATCH</div>` : `<div style="color:var(--muted);font-weight:700">—</div>`}
          <div class="match-bar" aria-hidden><div class="match-fill" style="width:${score!==null?score+'%':'0%'}"></div></div>
        </div>
      </div>
      <h3 style="margin-top:6px">${escapeHtml(feature)}</h3>
      <p class="summary">${escapeHtml(summary || desc).slice(0,600)}${(summary||desc).length>600?'…':''}</p>
      <div class="keywords" style="margin-top:8px">${(keywords||[]).slice(0,8).map(k=>`<span class="kw">${escapeHtml(k)}</span>`).join('')}</div>
      <div class="footer-actions" style="margin-top:10px">
        <button class="btn-sm edit focus-ring" data-id="${escapeHtml(id)}">Edit</button>
        <button class="btn-sm primary focus-ring" data-id="${escapeHtml(id)}">Copy ID</button>
        <button class="btn-sm focus-ring delete-btn" data-id="${escapeHtml(id)}" style="background:transparent;border:2px solid rgba(255,255,255,0.95);color:var(--white)">Delete</button>
      </div>
    `;
    card.innerHTML = metaHTML;

    card.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        e.stopPropagation();
        const id = btn.getAttribute('data-id');
        if(btn.classList.contains('edit')) {
          openEditModal(it, id);
        } else if(btn.textContent.trim() === 'Copy ID') {
          navigator.clipboard?.writeText(id).then(()=>{ uploadStatus.textContent='Copied ID to clipboard'; }).catch(()=>{ uploadStatus.textContent='Copy failed' });
        } else if(btn.classList.contains('delete-btn')) {
          if(!confirm('Delete this test case?')) return;
          try{
            const res = await fetch(`/api/testcase/${id}`, { method: 'DELETE' });
            const data = await res.json();
            if(!res.ok) throw new Error(data.detail||res.statusText);
            card.remove();
            uploadStatus.textContent='Deleted test case';
          }catch(err){ alert('Delete failed: '+err.message) }
        }
      });
    });

    targetContainer.appendChild(card);
  });
}

// client-side sorting helper
function sortClientSide(list, by, dir){
  try{
    const copy = Array.from(list);
    copy.sort((a,b)=>{
      if(by==='recent'){
        const ta = new Date(a.created_at||a.date||0).valueOf();
        const tb = new Date(b.created_at||b.date||0).valueOf();
        return (ta-tb)*(dir==='asc'?1:-1);
      }
      if(by==='id'){
        const ia = String(a.id||a['Test Case ID']||'');
        const ib = String(b.id||b['Test Case ID']||'');
        return ia.localeCompare(ib)*(dir==='asc'?1:-1);
      }
      return 0;
    });
    return copy;
  }catch(e){ return list; }
}

// modal
function openEditModal(item,id){
  _prevActiveElement = document.activeElement;
  document.body.classList.add('modal-open');
  modal.style.opacity='1'; modal.style.pointerEvents='auto';
  document.getElementById('edit-id').value = id;
  document.getElementById('edit-feature').value = item.feature || item['Feature'] || '';
  document.getElementById('edit-desc').value = item.description || item['Test Case Description'] || item.summary || '';
  document.getElementById('edit-prereq').value = item.prerequisites || item['Pre-requisites'] || '';
  document.getElementById('edit-steps').value = item.steps || item['Steps'] || '';
  setTimeout(()=> {
    const first = modal.querySelector('input, textarea, button, [tabindex]:not([tabindex="-1"])');
    if(first) first.focus();
  }, 120);
}
function closeModal(){
  modal.style.opacity='0'; modal.style.pointerEvents='none';
  document.body.classList.remove('modal-open');
  if(_prevActiveElement && typeof _prevActiveElement.focus === 'function') { try { _prevActiveElement.focus(); } catch(e) {} }
}
modalClose.addEventListener('click', closeModal);
document.getElementById('cancel-edit').addEventListener('click', closeModal);

// handle click outside modal (close)
modal.addEventListener('click',(e)=>{ if(e.target===modal) closeModal() });

// edit form submit
editForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const id = document.getElementById('edit-id').value;
  const payload = {
    feature: document.getElementById('edit-feature').value,
    description: document.getElementById('edit-desc').value,
    prerequisites: document.getElementById('edit-prereq').value,
    steps: document.getElementById('edit-steps').value,
  };
  document.getElementById('edit-status').textContent='Saving…';
  try{
    const res = await fetch(`/api/update/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const data = await res.json(); if(!res.ok) throw new Error(data.detail||res.statusText);
    document.getElementById('edit-status').textContent='Saved.';
    setTimeout(()=>{ closeModal(); if(lastView==='search') searchForm.dispatchEvent(new Event('submit')); else if(lastView==='all') fetchAllTests(); },700);
  }catch(err){ document.getElementById('edit-status').textContent='Save failed: '+err.message }
});

// escape html
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, function(c){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c];}); }

// export & clear cache
document.getElementById('export-json').addEventListener('click', ()=>{ fetch('/api/get-all').then(r=>r.json()).then(data=>{ const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='test_cases.json'; a.click(); URL.revokeObjectURL(url); }).catch(err=>{uploadStatus.textContent='Export failed: '+err.message}) });
allExport.addEventListener('click', ()=> document.getElementById('export-json').click());
document.getElementById('clear-cache').addEventListener('click', ()=>{ localStorage.clear(); uploadStatus.textContent='Local cache cleared' });

// sort controls
sortDirBtn.addEventListener('click', ()=>{ sortDir = (sortDir==='desc')?'asc':'desc'; sortDirBtn.style.transform = sortDir==='asc' ? 'rotate(180deg)' : 'rotate(0deg)'; if(lastView==='search') searchForm.dispatchEvent(new Event('submit')); else if(lastView==='all') fetchAllTests(); });
clearFiltersBtn.addEventListener('click', ()=>{ sortEl.value='relevance'; sortDir='desc'; sortDirBtn.style.transform='rotate(0deg)'; resultCount.textContent='Filters cleared'; setTimeout(()=>{ if(window.__lastCount) resultCount.textContent=window.__lastCount; },900); if(lastView==='search') searchForm.dispatchEvent(new Event('submit')); else if(lastView==='all') fetchAllTests(); });

// focus start
qInput.focus();
  </script>
</body>
</html>
